<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- title -->
    <title>Cart</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
    />
    <!-- google font -->
    <link
      href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,700"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css?family=Poppins:400,700&display=swap"
      rel="stylesheet"
    />
    <!-- fontawesome -->
    <link rel="stylesheet" href="assets/css/all.min.css" />
    <!-- bootstrap -->
    <link rel="stylesheet" href="assets/bootstrap/css/bootstrap.min.css" />
    <!-- owl carousel -->
    <link rel="stylesheet" href="assets/css/owl.carousel.css" />
    <!-- magnific popup -->
    <link rel="stylesheet" href="assets/css/magnific-popup.css" />
    <!-- animate css -->
    <link rel="stylesheet" href="assets/css/animate.css" />
    <!-- mean menu css -->
    <link rel="stylesheet" href="assets/css/meanmenu.min.css" />
    <!-- main style -->
    <link rel="stylesheet" href="assets/css/main.css" />
    <!-- responsive -->
    <link rel="stylesheet" href="assets/css/responsive.css" />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-cookie/3.0.5/js.cookie.min.js"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
  </head>
  <body>
    <!--PreLoader-->
    <div class="loader">
      <div class="loader-inner">
        <div class="circle"></div>
      </div>
    </div>
    <!--PreLoader Ends-->

    <!-- header -->
    <div class="top-header-area" id="sticker">
      <div class="container">
        <div class="row">
          <div class="col-lg-12 col-sm-12 text-center">
            <div class="main-menu-wrap">
              <!-- logo -->
              <div class="site-logo">
                <a href="index.html">
                  <img src="assets/img/logoburgerkha.png" alt="" />
                </a>
              </div>
              <!-- logo -->

              <!-- menu start -->
              <nav class="main-menu">
                <ul>
                  <li>
                    <div class="header-icons">
                      <a class="shopping-cart" href="cart.html"
                        ><i class="fas fa-shopping-cart"></i
                      ></a>
                      <a id="protectedAuth" href="login.html"
                        ><i class="bi bi-person-fill"></i
                      ></a>
                      <span
                        style="font-weight: bold; color: white"
                        id="displayName"
                      ></span>

                      <a
                        onclick="handleLogout()"
                        style="
                          font-weight: bold;
                          color: white;
                          font-size: 20px;
                          padding-top: 6px;
                        "
                        id="logoutButton"
                        ><i class="bi bi-box-arrow-right"></i
                      ></a>
                    </div>
                  </li>
                </ul>
              </nav>
              <a class="mobile-show search-bar-icon" href="#"
                ><i class="fas fa-search"></i
              ></a>
              <div class="mobile-menu"></div>
              <!-- menu end -->
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- end header -->

    <!-- breadcrumb-section -->
    <div class="breadcrumb-section breadcrumb-bg">
      <div class="container">
        <div class="row">
          <div class="col-lg-8 offset-lg-2 text-center">
            <div class="breadcrumb-text">
              <p>Fresh & Tasty</p>
              <h1>Cart</h1>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- end breadcrumb section -->

    <!-- cart -->
    <div class="cart-section mt-150 mb-150">
      <div class="container">
        <div class="row">
          <div class="col-lg-8 col-md-12">
            <div class="cart-table-wrap">
              <table class="cart-table">
                <thead class="cart-table-head">
                  <tr class="table-head-row">
                    <th class="product-remove"></th>
                    <th class="product-image">Product Image</th>
                    <th class="product-name">Name</th>
                    <th class="product-price">Price</th>
                    <th class="product-quantity">Quantity</th>
                  </tr>
                </thead>
                <tbody id="list-cart-item"></tbody>
              </table>
            </div>
          </div>

          <div class="col-lg-4">
            <div class="total-section">
              <table class="total-table">
                <thead class="total-table-head">
                  <tr class="table-total-row">
                    <th>Total</th>
                    <th>Price</th>
                  </tr>
                </thead>
                <tbody>
                  <tr class="total-data">
                    <td><strong>Total: </strong></td>
                    <td id="sub-total-quest"></td>
                  </tr>
                </tbody>
              </table>
              <div class="cart-buttons">
                <a
                  onclick="createOrder()"
                  id="button-checkout"
                  class="boxed-btn black"
                  >Check Out</a
                >
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- end cart -->

    <!-- logo carousel -->
    <div class="logo-carousel-section">
      <div class="container">
        <div class="row">
          <div class="col-lg-12">
            <div class="logo-carousel-inner">
              <div class="single-logo-item">
                <img src="assets/img/company-logos/1.png" alt="" />
              </div>
              <div class="single-logo-item">
                <img src="assets/img/company-logos/2.png" alt="" />
              </div>
              <div class="single-logo-item">
                <img src="assets/img/company-logos/3.png" alt="" />
              </div>
              <div class="single-logo-item">
                <img src="assets/img/company-logos/4.png" alt="" />
              </div>
              <div class="single-logo-item">
                <img src="assets/img/company-logos/5.png" alt="" />
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- end logo carousel -->

    <!-- footer -->
    <div class="footer-area">
      <div class="container">
        <div class="row">
          <div class="col-lg-3 col-md-6">
            <div class="footer-box about-widget">
              <h2 class="widget-title">About us</h2>
              <p>
                Ut enim ad minim veniam perspiciatis unde omnis iste natus error
                sit voluptatem accusantium doloremque laudantium, totam rem
                aperiam, eaque ipsa quae.
              </p>
            </div>
          </div>
          <div class="col-lg-3 col-md-6">
            <div class="footer-box get-in-touch">
              <h2 class="widget-title">Get in Touch</h2>
              <ul>
                <li>34/8, East Hukupara, Gifirtok, Sadan.</li>
                <li>support@fruitkha.com</li>
                <li>+00 111 222 3333</li>
              </ul>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- end footer -->

    <script>
      const handleLogout = () => {
        sessionStorage.removeItem("auth");
        window.location.reload();
      };
      $(document).ready(function () {
        const dataLogin = JSON.parse(sessionStorage.getItem("auth"));
        // Check if data exists and display it
        if (dataLogin) {
          $("#displayName").text(dataLogin.user.nama);
          $("#protectedAuth").hide();
        } else {
          $("#logoutButton").hide();
        }
      });
    </script>

    <!-- jquery -->
    <script src="assets/js/jquery-1.11.3.min.js"></script>
    <!-- bootstrap -->
    <script src="assets/bootstrap/js/bootstrap.min.js"></script>
    <!-- count down -->
    <script src="assets/js/jquery.countdown.js"></script>
    <!-- isotope -->
    <script src="assets/js/jquery.isotope-3.0.6.min.js"></script>
    <!-- waypoints -->
    <script src="assets/js/waypoints.js"></script>
    <!-- owl carousel -->
    <script src="assets/js/owl.carousel.min.js"></script>
    <!-- magnific popup -->
    <script src="assets/js/jquery.magnific-popup.min.js"></script>
    <!-- mean menu -->
    <script src="assets/js/jquery.meanmenu.min.js"></script>
    <!-- sticker js -->
    <script src="assets/js/sticker.js"></script>
    <!-- main js -->
    <script src="assets/js/main.js"></script>
    <script>
      $(document).ready(function () {
        const mappingImage = [
          { id: 1, img: "assets/img/products/sosis-img-1.PNG" },
          { id: 2, img: "assets/img/products/burger-img-1.PNG" },
          { id: 3, img: "assets/img/products/fries-img-1.PNG" },
          { id: 4, img: "assets/img/products/soda-img-1.PNG" },
          { id: 5, img: "assets/img/products/dbcb-img-1.PNG" },
        ];

        function getCartFromCookies() {
          return Cookies.get("cart") ? JSON.parse(Cookies.get("cart")) : [];
        }

        function formatToIDR(amount) {
          return new Intl.NumberFormat("id-ID", {
            style: "currency",
            currency: "IDR",
          }).format(amount);
        }

        let listDataCart = getCartFromCookies() || [];

        function calculateTotal(cart) {
          return cart.reduce(
            (total, item) => total + item.price * item.quantity,
            0
          );
        }

        $("#sub-total-quest").text(formatToIDR(calculateTotal(listDataCart)));

        window.removeFromCart = (button) => {
          try {
            const newItem = $(button).data("menu");
            listDataCart = listDataCart.filter((el) => el.id !== newItem.id);
            Cookies.set("cart", JSON.stringify(listDataCart), {
              expires: 1,
              path: "/",
            });

            $(button).closest("tr").remove();
            $("#sub-total-quest").text(
              formatToIDR(calculateTotal(listDataCart))
            );

            if (listDataCart.length === 0) {
              $("#list-cart-item").html(`
                    <tr>
                        <td colspan="5" class="text-center">Your cart is empty üõí</td>
                    </tr>
                `);
            }

            console.log("Item removed. Updated cart:", listDataCart);
          } catch (error) {
            console.error("Error removing item:", error);
          }
        };

        toastr.options = {
          closeButton: true,
          progressBar: true,
          positionClass: "toast-top-right",
          timeOut: "3000",
        };

        const user = sessionStorage.getItem("auth")
          ? JSON.parse(sessionStorage.getItem("auth"))
          : null;

        const clearCart = () => {
          try {
            listDataCart = [];
            Cookies.remove("cart", { path: "/" });

            $("#list-cart-item").html(`
                <tr>
                    <td colspan="5" class="text-center">Your cart is empty üõí</td>
                </tr>
            `);
            $("#sub-total-quest").text(formatToIDR(0));

            console.log("Cart cleared successfully.");
          } catch (error) {
            console.error("Error clearing cart:", error);
          }
        };

        // ‚úÖ Attach checkout event properly
        $("#button-checkout").click(async function () {
          let button = $(this);
          button.prop("disabled", true).addClass("loading");
          button.html('<span class="spinner">‚è≥</span> Loading...');

          if (listDataCart.length < 1) {
            toastr.error("Cart is empty");
            button
              .prop("disabled", false)
              .removeClass("loading")
              .text("Checkout");
            return;
          }

          if (!user?.user?.id) {
            toastr.error("Need to login first");
            button
              .prop("disabled", false)
              .removeClass("loading")
              .text("Checkout");
            return;
          }

          try {
            const response = await fetch(
              "https://fast-food-be.vercel.app/order/bookingorder",
              {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ user_id: user?.user?.id }),
              }
            );

            const data = await response.json();

            for (let el of listDataCart) {
              const responseOrderDetail = await fetch(
                "https://fast-food-be.vercel.app/detail/order_detail",
                {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify({
                    menu_id: el.id,
                    order_id: data.id,
                    quantity: el.quantity,
                  }),
                }
              );

              const dataOrderDetail = await responseOrderDetail.json();
              toastr.success(`${dataOrderDetail?.message} : ${el.name}`);
            }

            clearCart();
            setTimeout(() => {
              window.location.href = "checkout.html";
            }, 1000);
          } catch (error) {
            console.error("Something went wrong:", error);
            toastr.error("Error processing order, please try again.");
          }
        });

        if (listDataCart.length === 0) {
          $("#list-cart-item").html(`
            <tr>
                <td colspan="5" class="text-center">Your cart is empty üõí</td>
            </tr>
        `);
        } else {
          $.each(listDataCart, (index, item) => {
            $("#list-cart-item").append(`
                <tr class="table-body-row">
                    <td class="product-remove">
                        <a data-menu='${JSON.stringify(
                          item
                        )}' onclick="removeFromCart(this)">
                            <i class="far fa-window-close"></i>
                        </a>
                    </td>
                    <td class="product-image">
                        <img src="${
                          mappingImage.find((el) => el.id === item.id)?.img ||
                          ""
                        }" alt="" />
                    </td>
                    <td class="product-name">${item.name}</td>
                    <td class="product-price">${formatToIDR(
                      item.price || 0
                    )}</td>
                    <td class="product-quantity">
                        <input type="number" disabled placeholder="0" value="${
                          item.quantity || 0
                        }" />
                    </td>
                </tr>
            `);
          });
        }
      });
    </script>
  </body>
</html>
